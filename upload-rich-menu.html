<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rich Menu åœ–ç‰‡ä¸Šå‚³å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #64748b;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="file"]:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .result.success {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
            display: block;
        }

        .result.error {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #991b1b;
            display: block;
        }

        .result.loading {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            color: #1e40af;
            display: block;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid #2563eb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box h3 {
            color: #1e40af;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .info-box p {
            color: #475569;
            font-size: 13px;
            line-height: 1.6;
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 12px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¤ Rich Menu åœ–ç‰‡ä¸Šå‚³</h1>
        <p class="subtitle">é€é API ä¸Šå‚³ Rich Menu åœ–ç‰‡ï¼ˆé–‹ç™¼è€…æ–¹å¼ï¼‰</p>

        <div class="info-box">
            <h3>ğŸ“‹ ä½¿ç”¨èªªæ˜</h3>
            <p>
                â€¢ åœ–ç‰‡å°ºå¯¸ï¼š2500 x 1686 åƒç´ <br>
                â€¢ æª”æ¡ˆæ ¼å¼ï¼šPNG æˆ– JPEG<br>
                â€¢ æª”æ¡ˆå¤§å°ï¼š< 1MB<br>
                â€¢ ä¸Šå‚³å¾Œå¯è¨­å®šç‚ºé è¨­ Rich Menu
            </p>
        </div>

        <form id="uploadForm">
            <div class="form-group">
                <label for="richMenuId">Rich Menu ID:</label>
                <input 
                    type="text" 
                    id="richMenuId" 
                    value="richmenu-a6389c5b70cb89ab3df24a986c5c3302" 
                    placeholder="è¼¸å…¥ Rich Menu ID"
                    required
                >
            </div>

            <div class="form-group">
                <label for="imageFile">é¸æ“‡åœ–ç‰‡æª”æ¡ˆ:</label>
                <input 
                    type="file" 
                    id="imageFile" 
                    accept="image/png,image/jpeg,image/jpg" 
                    required
                >
                <div class="file-info" id="fileInfo" style="display: none;"></div>
            </div>

            <div class="button-group">
                <button type="button" class="btn-secondary" onclick="createRichMenu()">å‰µå»ºæ–°çš„ Rich Menu</button>
                <button type="submit" class="btn-primary">ä¸Šå‚³åœ–ç‰‡</button>
            </div>
        </form>

        <div id="result"></div>

        <div id="nextStep" style="display: none; margin-top: 20px;">
            <div class="info-box">
                <h3>âœ… ä¸Šå‚³æˆåŠŸï¼ä¸‹ä¸€æ­¥ï¼š</h3>
                <p>
                    åœ–ç‰‡å·²ä¸Šå‚³æˆåŠŸï¼Œç¾åœ¨å¯ä»¥è¨­å®šç‚ºé è¨­ Rich Menuã€‚
                </p>
                <button 
                    type="button" 
                    class="btn-primary" 
                    style="margin-top: 10px;"
                    onclick="setAsDefault()"
                >
                    è¨­å®šç‚ºé è¨­ Rich Menu
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://music-website-six-opal.vercel.app/api/admin/rich-menu';
        let currentRichMenuId = 'richmenu-a6389c5b70cb89ab3df24a986c5c3302';

        // é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
        document.getElementById('imageFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const fileInfo = document.getElementById('fileInfo');
                const sizeKB = (file.size / 1024).toFixed(2);
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                
                fileInfo.innerHTML = `
                    <strong>æª”æ¡ˆè³‡è¨Šï¼š</strong><br>
                    åç¨±: ${file.name}<br>
                    å¤§å°: ${sizeKB} KB (${sizeMB} MB)<br>
                    é¡å‹: ${file.type}
                    ${file.size > 1024 * 1024 ? '<br><span style="color: red;">âš ï¸ æª”æ¡ˆè¶…é 1MBï¼Œè«‹å£“ç¸®å¾Œå†ä¸Šå‚³</span>' : ''}
                `;
                fileInfo.style.display = 'block';
            }
        });

        // ä¸Šå‚³è¡¨å–®
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const richMenuId = document.getElementById('richMenuId').value.trim();
            const imageFile = document.getElementById('imageFile').files[0];
            const resultDiv = document.getElementById('result');
            const nextStepDiv = document.getElementById('nextStep');
            
            if (!imageFile) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'âŒ è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ';
                return;
            }

            // é©—è­‰æª”æ¡ˆå¤§å°
            if (imageFile.size > 1024 * 1024) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'âŒ æª”æ¡ˆå¤§å°è¶…é 1MBï¼Œè«‹å£“ç¸®å¾Œå†ä¸Šå‚³';
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = 'â³ ä¸Šå‚³ä¸­...';
            nextStepDiv.style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('richMenuId', richMenuId);
                formData.append('image', imageFile);

                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });

                // æª¢æŸ¥éŸ¿æ‡‰ç‹€æ…‹
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { error: errorText || `HTTP ${response.status}: ${response.statusText}` };
                    }
                    throw new Error(errorData.error || errorData.message || 'ä¸Šå‚³å¤±æ•—');
                }

                // æª¢æŸ¥éŸ¿æ‡‰å…§å®¹é¡å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`ä¼ºæœå™¨è¿”å›é JSON æ ¼å¼: ${text.substring(0, 100)}`);
                }

                const data = await response.json();

                if (data.success) {
                    currentRichMenuId = richMenuId;
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        âœ… <strong>ä¸Šå‚³æˆåŠŸï¼</strong><br>
                        Rich Menu ID: ${data.richMenuId}<br>
                        æª”æ¡ˆåç¨±: ${data.fileName}<br>
                        æª”æ¡ˆå¤§å°: ${(data.fileSize / 1024).toFixed(2)} KB
                    `;
                    nextStepDiv.style.display = 'block';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ <strong>ä¸Šå‚³å¤±æ•—</strong><br>${data.error || 'æœªçŸ¥éŒ¯èª¤'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ <strong>éŒ¯èª¤</strong><br>${error.message || 'æœªçŸ¥éŒ¯èª¤'}<br><small>è«‹æª¢æŸ¥ç€è¦½å™¨ Console æŸ¥çœ‹è©³ç´°éŒ¯èª¤</small>`;
                console.error('ä¸Šå‚³éŒ¯èª¤:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
            }
        });

        // å‰µå»ºæ–°çš„ Rich Menu
        async function createRichMenu() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = 'â³ å‰µå»ºä¸­...';

            try {
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'create'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentRichMenuId = data.richMenuId;
                    document.getElementById('richMenuId').value = data.richMenuId;
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        âœ… <strong>Rich Menu å‰µå»ºæˆåŠŸï¼</strong><br>
                        Rich Menu ID: ${data.richMenuId}<br>
                        ç¾åœ¨å¯ä»¥ä¸Šå‚³åœ–ç‰‡äº†
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ <strong>å‰µå»ºå¤±æ•—</strong><br>${data.error || 'æœªçŸ¥éŒ¯èª¤'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ <strong>éŒ¯èª¤</strong><br>${error.message}`;
            }
        }

        // è¨­å®šç‚ºé è¨­
        async function setAsDefault() {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = 'â³ è¨­å®šä¸­...';

            try {
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'set_default',
                        richMenuId: currentRichMenuId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        âœ… <strong>è¨­å®šæˆåŠŸï¼</strong><br>
                        Rich Menu å·²è¨­å®šç‚ºé è¨­ï¼Œæ‰€æœ‰ç”¨æˆ¶éƒ½å¯ä»¥çœ‹åˆ°
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ <strong>è¨­å®šå¤±æ•—</strong><br>${data.error || 'æœªçŸ¥éŒ¯èª¤'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ <strong>éŒ¯èª¤</strong><br>${error.message}`;
            }
        }
    </script>
</body>
</html>

