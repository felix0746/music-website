# LINE Bot 功能檢視與整合建議

## 📋 目前 LINE Bot 功能清單

### 核心功能（Webhook 處理）

#### 1. 新用戶報名流程
- **觸發條件**：用戶輸入「報名」或「課程」或直接提供報名資訊
- **處理方式**：文字訊息解析
- **功能**：
  - 解析「姓名：XXX 課程：XXX」格式
  - 創建用戶記錄
  - 自動發送付款資訊
  - 支援 4 種課程：歌唱課、吉他課、創作課、春曲創作團班

#### 2. 付款回報流程
- **觸發條件**：用戶輸入「付款」、「匯款」、「後五碼」
- **處理方式**：文字訊息解析
- **功能**：
  - 解析付款資訊（姓名、後五碼、金額、備註）
  - 支援部分付款（PARTIAL）
  - 支援補付流程
  - 支援超額付款處理
  - 自動計算尚需補付金額
  - 更新付款狀態和日期

#### 3. 取消課程流程
- **觸發條件**：用戶輸入「取消」、「退課」、「退費」
- **處理方式**：文字訊息解析
- **功能**：
  - 解析取消資訊（姓名、課程、取消原因、退費需求）
  - 驗證用戶身份
  - 計算退費金額（根據取消時間：7天內全額，7天後50%）
  - 更新取消狀態和退費狀態

#### 4. 重新報名流程
- **觸發條件**：已報名用戶輸入「報名」或提供報名資訊
- **處理方式**：檢查用戶狀態後處理
- **功能**：
  - 檢查當前報名狀態
  - 如果已付款，提示需先取消
  - 如果未付款，允許重新報名
  - 重置報名和付款狀態

#### 5. 一般回覆
- **觸發條件**：已報名用戶輸入其他訊息
- **功能**：提供選項清單（付款回報、重新報名、取消課程）

---

### 後台管理功能

#### 6. 單一發送訊息
- **API**：`/api/admin/send-line-message`
- **功能**：後台管理員發送訊息給單一學員

#### 7. 批次發送訊息
- **API**：`/api/admin/batch-send-message`
- **功能**：
  - 支援指定學員 ID 列表
  - 支援篩選條件（付款狀態、報名狀態、課程、搜尋）
  - 支援訊息模板（付款提醒、開課提醒、付款確認、課程取消）
  - 支援變數替換（{name}, {course}, {amount} 等）
  - 批次處理（每批 5 個，避免過載）

#### 8. 退費處理通知
- **API**：`/api/admin/students/[id]/refund`
- **功能**：後台處理退費後，自動發送 LINE 通知給學員

---

## 🔄 可以整合/改進的功能

### 高優先級改進項目

#### 1. **Rich Menu（圖文選單）整合**
**目前狀況**：無 Rich Menu，用戶需要手動輸入關鍵字

**可以整合的功能**：
- ✅ 課程介紹（點擊後顯示課程輪播卡片）
- ✅ 立即報名（點擊後引導報名流程）
- ✅ 付款資訊（點擊後直接顯示付款資訊）
- ✅ 付款回報（點擊後引導付款回報流程）
- ✅ 取消課程（點擊後引導取消流程）
- ✅ 退費查詢（點擊後查詢退費狀態）
- ✅ 聯絡客服（點擊後顯示聯絡方式）

**動態 Rich Menu**：
- 根據用戶狀態顯示不同選單
  - 未報名：課程介紹、立即報名、付款資訊
  - 已報名未付款：付款資訊、付款回報、取消課程
  - 已付款：課程資訊、取消課程、退費查詢
  - 已取消：退費查詢、重新報名、課程介紹

---

#### 2. **Template Message（模板訊息）整合**
**目前狀況**：所有訊息都是純文字

**可以整合的功能**：

**A. 課程介紹輪播卡片（Carousel）**
- 4 個課程卡片，每個包含：
  - 課程圖片
  - 課程名稱
  - 課程價格
  - 按鈕：「了解詳情」、「立即報名」

**B. 付款資訊卡片（Buttons）**
- 標題：「您的付款資訊」
- 顯示：銀行、帳號、戶名、金額
- 按鈕：「複製帳號」、「我已付款，開始回報」

**C. 付款回報引導卡片（Buttons）**
- 標題：「付款回報」
- 文字：「請選擇回報方式」
- 按鈕：「快速回報」、「詳細回報」

**D. 取消課程表單卡片（Buttons）**
- 標題：「取消課程申請」
- 文字：「請選擇取消原因」
- 按鈕：「時間無法配合」、「其他原因」、「查看退費政策」

**E. 退費狀態查詢卡片（Buttons）**
- 標題：「退費狀態查詢」
- 顯示：退費狀態、退費金額、預計完成時間
- 按鈕：「查看退費政策」、「聯絡客服」

---

#### 3. **Quick Reply（快速回覆）整合**
**目前狀況**：無 Quick Reply

**可以整合的功能**：

**A. 報名流程**
- 用戶點擊「立即報名」後，顯示 Quick Reply：
  - 「歌唱課」
  - 「吉他課」
  - 「創作課」
  - 「春曲創作團班」

**B. 付款回報流程**
- 用戶點擊「付款回報」後，顯示 Quick Reply：
  - 「後五碼：12345」
  - 「金額：3000」
  - 「已完成付款」

**C. 取消原因選擇**
- 用戶點擊「取消課程」後，顯示 Quick Reply：
  - 「時間無法配合」
  - 「個人因素」
  - 「其他原因」

**D. 退費需求選擇**
- 取消流程中，顯示 Quick Reply：
  - 「需要退費」
  - 「不需要退費」

---

#### 4. **Postback 事件處理**
**目前狀況**：只處理文字訊息（`message` 事件）

**需要新增**：
- 處理 `postback` 事件（按鈕點擊）
- 處理 `follow` 事件（用戶加入好友）
- 處理 `unfollow` 事件（用戶封鎖）

**可以整合的功能**：
- Rich Menu 按鈕點擊
- Template Message 按鈕點擊
- Quick Reply 選擇

---

#### 5. **狀態查詢功能**
**目前狀況**：無主動查詢功能

**可以整合的功能**：

**A. 報名狀態查詢**
- 點擊「我的報名」→ 顯示：
  - 報名課程
  - 報名日期
  - 付款狀態
  - 付款金額

**B. 付款狀態查詢**
- 點擊「付款狀態」→ 顯示：
  - 應付金額
  - 已付金額
  - 尚需補付金額
  - 付款日期

**C. 退費狀態查詢**
- 點擊「退費查詢」→ 顯示：
  - 退費狀態（待處理/處理中/已完成）
  - 退費金額
  - 預計完成時間

---

#### 6. **付款資訊快速查詢**
**目前狀況**：付款資訊在報名時發送一次

**可以整合的功能**：
- 點擊「付款資訊」→ 直接顯示付款資訊（無需輸入）
- 自動帶入用戶報名的課程金額
- 提供「複製帳號」按鈕（透過 URI Action）

---

#### 7. **取消流程優化**
**目前狀況**：需要輸入完整格式（姓名、課程、取消原因、退費需求）

**可以整合的功能**：
- 點擊「取消課程」→ 自動帶入用戶資訊
- 使用 Quick Reply 選擇取消原因
- 使用 Quick Reply 選擇退費需求
- 只需確認姓名即可完成取消

---

#### 8. **付款回報流程優化**
**目前狀況**：需要輸入完整格式（姓名、後五碼、金額）

**可以整合的功能**：
- 點擊「付款回報」→ 自動帶入用戶姓名和課程
- 使用 Quick Reply 快速輸入後五碼
- 使用 Quick Reply 快速輸入金額
- 減少輸入步驟

---

### 中優先級改進項目

#### 9. **歡迎訊息優化**
**目前狀況**：純文字歡迎訊息

**可以整合的功能**：
- 用戶加入好友時，自動發送歡迎訊息
- 包含 Rich Menu 說明
- 包含課程介紹卡片
- 包含 Quick Reply 選項

---

#### 10. **課程詳情查詢**
**目前狀況**：課程資訊在歡迎訊息中簡單列出

**可以整合的功能**：
- 點擊「課程介紹」→ 發送課程輪播卡片
- 點擊某個課程的「了解詳情」→ 顯示：
  - 課程圖片
  - 課程描述
  - 課程特色
  - 課程價格
  - 上課時間
  - 「立即報名」按鈕

---

#### 11. **補付提醒功能**
**目前狀況**：部分付款後，用戶需要主動回報補付

**可以整合的功能**：
- 部分付款後，定期發送補付提醒（可設定間隔）
- 提醒訊息包含：
  - 尚需補付金額
  - 付款資訊
  - 「立即補付」按鈕

---

#### 12. **退費政策查詢**
**目前狀況**：退費政策在取消流程中說明

**可以整合的功能**：
- 點擊「查看退費政策」→ 顯示：
  - 退費規則（7天內全額，7天後50%）
  - 退費流程
  - 退費時間

---

### 低優先級改進項目

#### 13. **上課提醒功能**
**目前狀況**：無上課提醒

**可以整合的功能**：
- 課程開始前自動發送提醒
- 包含上課時間、地點、注意事項

---

#### 14. **課程評價功能**
**目前狀況**：無評價功能

**可以整合的功能**：
- 課程結束後，發送評價邀請
- 使用 Template Message 收集評價

---

#### 15. **FAQ 查詢功能**
**目前狀況**：無 FAQ 功能

**可以整合的功能**：
- 點擊「常見問題」→ 顯示 FAQ 列表
- 使用 Template Message 展示問題和答案

---

## 📊 功能整合優先順序建議

### 第一階段：基礎互動（最重要）
1. ✅ 實作 Postback 事件處理
2. ✅ 建立 Rich Menu（固定版本）
3. ✅ 實作「付款資訊」快速查詢
4. ✅ 實作「報名狀態」查詢

### 第二階段：進階互動
5. ✅ 實作課程介紹 Template Message（輪播卡片）
6. ✅ 實作付款回報引導流程（Template + Quick Reply）
7. ✅ 實作取消課程引導流程（Template + Quick Reply）
8. ✅ 實作退費狀態查詢

### 第三階段：動態選單
9. ✅ 實作動態 Rich Menu（根據用戶狀態）
10. ✅ 優化歡迎訊息（包含 Rich Menu 說明）

### 第四階段：自動化功能
11. ✅ 實作補付提醒
12. ✅ 實作上課提醒
13. ✅ 實作課程評價

---

## 🎯 整合後的用戶體驗流程

### 新用戶流程
```
用戶加入 LINE
  ↓
自動發送歡迎訊息 + Rich Menu
  ↓
點擊「課程介紹」
  ↓
顯示課程輪播卡片
  ↓
點擊某課程「立即報名」
  ↓
使用 Quick Reply 選擇課程
  ↓
引導輸入姓名
  ↓
完成報名，發送付款資訊
```

### 已報名用戶流程
```
用戶打開聊天室
  ↓
Rich Menu 顯示（根據狀態）
  ↓
點擊「付款資訊」
  ↓
直接顯示付款資訊（無需輸入）
  ↓
點擊「我已付款，開始回報」
  ↓
使用 Quick Reply 輸入後五碼和金額
  ↓
完成付款回報
```

### 取消課程流程
```
用戶點擊「取消課程」
  ↓
顯示取消表單卡片
  ↓
使用 Quick Reply 選擇取消原因
  ↓
使用 Quick Reply 選擇退費需求
  ↓
確認姓名
  ↓
完成取消，顯示退費資訊
```

---

## 📝 技術實現要點

### 需要新增的程式碼
1. **Postback 事件處理器**
   - 處理 Rich Menu 點擊
   - 處理 Template Message 按鈕點擊
   - 處理 Quick Reply 選擇

2. **Rich Menu 管理**
   - 建立 Rich Menu API
   - 設定 Rich Menu 到用戶
   - 動態切換 Rich Menu

3. **Template Message 建立函數**
   - 課程輪播卡片
   - 付款資訊卡片
   - 取消表單卡片
   - 退費狀態卡片

4. **Quick Reply 建立函數**
   - 課程選擇
   - 取消原因選擇
   - 退費需求選擇
   - 付款資訊輸入

5. **狀態查詢函數**
   - 查詢報名狀態
   - 查詢付款狀態
   - 查詢退費狀態

---

## 💡 整合後的優勢

### 用戶體驗提升
- ✅ 減少輸入：從手動輸入改為點擊按鈕
- ✅ 流程清楚：引導式流程，降低錯誤
- ✅ 即時查詢：可隨時查詢狀態
- ✅ 視覺化：圖片和卡片更友善

### 管理效率提升
- ✅ 減少客服負擔：常見問題自動回答
- ✅ 減少錯誤：格式化的輸入減少解析錯誤
- ✅ 提高完成率：引導式流程提高操作完成率

---

## 🚀 建議實作順序

1. **第一階段**（1-2 天）：
   - Postback 事件處理
   - 固定 Rich Menu
   - 付款資訊快速查詢

2. **第二階段**（2-3 天）：
   - 課程介紹 Template Message
   - 付款回報引導流程
   - 取消課程引導流程

3. **第三階段**（1-2 天）：
   - 動態 Rich Menu
   - 退費狀態查詢
   - 優化歡迎訊息

4. **第四階段**（可選）：
   - 自動提醒功能
   - 評價功能
   - FAQ 功能

